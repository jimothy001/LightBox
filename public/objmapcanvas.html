<!DOCTYPE html>
<html>
	<head>

		<title>SANDBOX</title>
			

	<style>
	
		body {
			background-color: #222;
		}
		
		
		#map {
				width: 100%;
				height:100%;
				position: relative;
				float: left;
				display: block;
		}
		
		.image {
			width: 27px;
			height: 27px;
			position: relative;
			float: left;
			background-size: cover;
		}
		
		.image:hover {
			z-index:1000;
			-moz-box-shadow: 0 0 8px 3px #ffffff;
			-webkit-box-shadow: 0 0 8px 3px #ffffff;
			box-shadow: 0 0 8px 3px #ffffff;
		}
		
		#preview {
			position:absolute;
			margin-left: 20%;
			margin-right: 20%;		
			width:5px;
			height: 5px;
		}
		
		#preview.active {
			margin-top: 2%;
			width: 60%;
			height: 90%;
		}
		
		#preview img {
			max-width: 100%;
			max-height: 100%;
			display: block;
			margin: auto;
			position: absolute;
			top: 0;
			bottom: 0;
			left: 0;
			right: 0;
			webkit-box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
			-moz-box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
			box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5)
		}
		
		.button {
			color: white;
			font-family: sans-serif;
			margin: auto;
			position: absolute;
			background-color: #222;
			display: block;
			padding: 5px;		
			position: absolute;
			left: 0px;
		}
		
		.button:hover {
			text-decoration: underline;
			cursor: pointer;			
		}
		
		.metadata {
			position: absolute;
			background-color: black;
			opacity: .6;
			color: white;
			font-family: sans-serif;
		}
		
		.metadata .p {
			margin: 20px;
			float: left;
			padding: 3px;
			clear:both;
		}
		
		canvas {
			
		}
	
	</style>
	</head>
	
	<body>
		<canvas id="map"></canvas>
		<div id="preview">
			<img class ='img-preview'>
			<div class='button'>Add to tray</div>
			<div class='metadata'>
			<span class="p" id='sort'></span>
			<span class="p">Description:  <span id="description"></span></span>
			<span class="p">Title: <span id="title"></span></span>
			<span class="p">Dated: <span id="date"></span></span>
			
		</div></div>
		
	<script type="text/javascript" src="lib/jquery-1.8.2.js" ></script>  
	<script src="https://cdn.socket.io/socket.io-1.0.6.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0/handlebars.min.js"></script>
	
	<script id="preview-template" type="text/x-handlebars-template">
		<img class ='img-preview' src='{{primaryimageurl}}'>
		<div class='button'>Add to tray</div>
		<div class='metadata'>
			<span class="p" id='sort'></span>
			<span class="p">Description: {{#if description}} {{description}} {{else}} No description {{/if}}</span>
			<span class="p">Title: {{#if title}} {{title}} {{else}} No title {{/if}}</span>
			<span class="p">Dated: {{#if dated}} {{dated}} {{else}} No date {{/if}}</span>
			
		</div>
	</script>
	
	<script>
		var i = 0;
		var art = {};
		art.records = [];
		var curr = false;
		var host = window.location.host;
		var socket = io(host);
		var images2 = [];
		var sort = window.location.search.substr(1);
		var grid = true;
		
		var map = document.getElementById('map');
		var ctx = map.getContext('2d');
		var h;
		var itemX = 0;
	
		map.height = window.innerHeight - 15;
		map.width = window.innerWidth - 15;
		
		getMoreArt(0);
		
		$("#preview").css("opacity", 0);
		
		
		$(document).on("click", function(e) {
			console.log(e);
			if($(e.target).hasClass("button")) {
				console.log(curr);
				socket.emit('add-item', {
					url: curr
				});
			} else if($(e.target).attr("id") == "map") {
					var x = Math.floor((e.offsetX) / h);
					console.log(x);
					console.log(y);
					var y = Math.floor((e.offsetY) / h);
					curr = art.records[y*itemX+x];
				
					$("#preview .img-preview").attr("src", curr.primaryimageurl);
					$("#title").html(curr.title);
					$("#description").html(curr.description);
					$("#date").html(curr.dated);
			
				
					$("#map").css("opacity", .1);
					$("#preview").addClass("active");
					$("#sort").html(sort+": "+curr[sort]); 
					var $text = $("#preview .metadata");

					$text.hide();
				
					$(".img-preview").on("mouseover", function() {
						var $img = $("#preview .img-preview");
						$text.css("margin-left", $img.css("margin-left"));
						$text.css("margin-top", $img.css("margin-top"));
						$text.height($img.height());
						$text.width($img.width());
						$text.show();
					});
					$(".img-preview").on("mouseout", function() {
						$text.hide();
					});			
					$("#preview").animate({opacity: 1}, 500, function() {
				
					});
			} else {					
				
					$("#preview").animate({opacity: 0}, 500, function() {
					$("#preview").removeClass("active");
					//$("#preview").empty();
					$("#map").css("opacity", 1);
					curr = false;
				});
			}
		});
		
	
		socket.on('send-items', function(data) {
			console.log(data);
		});

		function customSort(a,b) {
			if ( a[sort] < b[sort] )
					return -1;
			if ( a[sort] > b[sort] )
					return 1;
			return 0;
		
		}
		
		function getMoreArt(count) {
			$.get("http://api.harvardartmuseums.org/object?gallery=any&apikey=f5473230-3f68-11e4-89b4-73adcea7266b&size=100&from="+count, function(data) {
				console.log(data.info.totalrecords);
				$.each(data.records, function(j, record) {
					if(record.primaryimageurl) art.records.push(record);
					else console.log("no art");
				});
				var next = count+100;
				if(data.info.pages > data.info.page) window.setTimeout(getMoreArt(next), 500);
				else {
					art.records.sort(customSort);
					populateMap();
				}
			});	
		}
		
		function populateMap() {
			h = Math.sqrt((window.innerWidth - 20)*(window.innerHeight-20) / art.records.length);
			itemX = Math.floor(map.width / h);
			for(i=0; i < art.records.length; i++) {
				var x = (i % itemX)*h;
				var y = Math.floor(i/itemX)*h;
				addImage(i, x, y);	
			}
						
		
		}

	function addImage(order, x, y) {
		var base_image = new Image();
		base_image.src = art.records[order].primaryimageurl;
		base_image.onload = function(){

		
			var size = base_image.height;
			if(base_image.height > base_image.width) size = base_image.width;
			ctx.drawImage(base_image, 0, 0, size, size, x, y, h, h);		
			
			
		}				
	}

	
	</script>
	</body>
</html>