<!DOCTYPE html>
<html>
	<head>

		<title>SANDBOX</title>
		<script type="text/javascript" src="lib/jquery-1.8.2.js" ></script>  
		<script type="text/javascript" src="lib/fabric.js"></script>
	<style>
		#sandbox 
		{
			width: 100%;
			height:90%;
			background-color: white;
			position: relative;
			float: left;
			display: block;
		}
		
		canvas {

		}
		
		.canvas-container {
			float:left;
			position: 'relative'
		}
		
		html,body {

			margin: 0;
			padding: 0;
		}
		.closebutton, .maxbutton, .minbutton{
			position: absolute;
			z-index: 999;
			display: none;
			border-radius: 50%;
		    width: 40px;
		    height: 40px;
		    border: 3px solid #fff;
		    color: white;
		    z-index: 999;
		}
		.closebutton:hover, .maxbutton:hover, .minbutton:hover{
			cursor: pointer;
		}
		.closebutton{
		    background: url('img/icon_close.png');
		}
		.maxbutton{
		    background: url('img/icon_max.png');
		}
		.minbutton{
		    background: url('img/icon_min.png');
		}
		.panel{
			margin: 10px;
			border: 1px solid #ccc;
		}
		.panel_zoom{
			margin: 10px;
			position: absolute;
			top: 0;
			left: 0;
			display: none;
			border: 1px solid #ccc;
		}
		.divider div{
			height: 602px;
			width: 10px;
			border-left: 1px solid #ccc;
			border-right: 1px solid #ccc;
			background: white;
			position: absolute;
			top: 10px;
			z-index: 99999;
		}
		.divider div:nth-child(1) {left: 325px;}
		.divider div:nth-child(2) {left: 645px;}
		.divider div:nth-child(3) {left: 965px;}
		.divider div:nth-child(4) {left: 1285px;}
	</style>
	</head>
	
	<body>
		<div class="closebutton"></div>
		<div class="maxbutton"></div>
		<div class="minbutton"></div>

<div class='divider'>
<div></div>
<div></div>
<div></div>
<div></div>
</div>
		<canvas id="p1" class="panel" width="320" height="600"></canvas>
		<canvas id="p2" class="panel" width="320" height="600"></canvas>
		<canvas id="p3" class="panel" width="320" height="600"></canvas>
		<canvas id="p4" class="panel" width="320" height="600"></canvas>
		<canvas id="p5" class="panel" width="320" height="600"></canvas>
		

<div class="panel_zoom">
<canvas id="pzoom" width="1600" height="600"></canvas>	
</div>
		

		<script type="text/javascript" src="sandbox_channels.js"></script>
		
<script>
//normal
var p1 = new fabric.Canvas("p1");
//color bands
var p2 = new fabric.Canvas("p2");
var p3 = new fabric.Canvas("p3");
var p4 = new fabric.Canvas("p4");
var p5 = new fabric.Canvas("p5");
var pointer = new canvasPointer();
var canvases = [p1, p2, p3, p4, p5];



var pzoom = new fabric.Canvas("pzoom");

//keycodes
var PLUS = 187;
var MINUS = 189;
// end keycodes

var activeObjs = [];
var activeSet = null;

var activezoom;
var active;

var down = false;

var occur_once = false;
var order = 0;
var sample1 = {"accessionyear":"1951","technique":null,"mediacount":0,"edition":null,"totalpageviews":636,"groupcount":1,"people":[{"birthplace":"Paris","name":"Georges Pierre Seurat","prefix":null,"personid":28633,"role":"Artist","displayorder":1,"culture":"French","displaydate":"1859 - 1891","deathplace":"Paris","displayname":"Georges Pierre Seurat"}],"objectnumber":"1951.62","colorcount":10,"lastupdate":"2014-10-02T04:42:16-0400","rank":142,"imagecount":3,"description":null,"dateoflastpageview":"2014-10-01","dateoffirstpageview":"2009-05-16","primaryimageurl":"http://nrs.harvard.edu/urn-3:HUAM:DDC251930_dynmc","colors":[{"percent":0.34326241134752,"spectrum":"#86c440","color":"#96964b","css3":"#cd853f","hue":"Green"},{"percent":0.27148936170213,"spectrum":"#2eb45d","color":"#324b32","css3":"#2f4f4f","hue":"Green"},{"percent":0.17475177304965,"spectrum":"#4ab851","color":"#4b6432","css3":"#556b2f","hue":"Green"},{"percent":0.067375886524823,"spectrum":"#8163ab","color":"#9696af","css3":"#a9a9a9","hue":"Blue"},{"percent":0.06645390070922,"spectrum":"#64bc46","color":"#647d32","css3":"#556b2f","hue":"Green"},{"percent":0.022198581560284,"spectrum":"#8c5fa8","color":"#afafaf","css3":"#a9a9a9","hue":"Grey"},{"percent":0.014893617021277,"spectrum":"#c25687","color":"#7d4b32","css3":"#8b4513","hue":"Brown"},{"percent":0.013829787234043,"spectrum":"#c25687","color":"#af967d","css3":"#bc8f8f","hue":"Brown"},{"percent":0.0092198581560284,"spectrum":"#e9715f","color":"#c8af7d","css3":"#d2b48c","hue":"Brown"},{"percent":0.0090070921985816,"spectrum":"#8c5fa8","color":"#c8c8c8","css3":"#c0c0c0","hue":"Grey"}],"dated":"1884-1885","contextualtextcount":0,"copyright":null,"period":null,"url":"http://harvardartmuseums.org/art/229049","provenance":"Georges Lecomte, Paris. [Reid Gallery, Glasgow], sold ; to [Alex Reid and Lefèvre,Ltd., London],  sold; to D. W. T. Cargill, Lanark, Scotland, (1927-1932).Bignou Gallery, New York. Stanley L. Barbee, Beverly Hills, CA, sold; [at his sale, Parke-Bernet, NY, April 20, 1944, no. 17]; to Maurice Wertheim, New York, 1944 - 1951), bequest; to Fogg Art Museum, 1951. \r\n\r\nNotes:\r\nReid Gallery and Lefèvre partnered in the 1920s. Alex Reid and Lefèvre,Ltd., was also known as The Lefevre Gallery.","images":[{"baseimageurl":"http://nrs.harvard.edu/urn-3:HUAM:DDC251930_dynmc","primarydisplay":1,"publiccaption":null,"copyright":"President and Fellows of Harvard College","renditionnumber":"DDC251930"},{"baseimageurl":"http://nrs.harvard.edu/urn-3:HUAM:DDC251959_dynmc","primarydisplay":0,"publiccaption":null,"copyright":"President and Fellows of Harvard College","renditionnumber":"DDC251959"},{"baseimageurl":"http://nrs.harvard.edu/urn-3:HUAM:80668_dynmc","primarydisplay":0,"publiccaption":null,"copyright":"President and Fellows of Harvard College","renditionnumber":"80668"}],"publicationcount":28,"objectid":229049,"culture":"French","verificationleveldescription":"Best. Object is extensively researched, well described and information is vetted","standardreferencenumber":null,"worktypes":[{"worktype":"painting"}],"department":"Department of Paintings, Sculpture & Decorative Arts","state":null,"markscount":2,"contact":"am_europeanamerican@harvard.edu","titlescount":1,"id":229049,"title":"Seated Figures, Study for \"A Sunday Afternoon on the Island of La Grande Jatte\"","verificationlevel":4,"division":"European and American Art","style":null,"commentary":null,"relatedcount":1,"datebegin":1884,"totaluniquepageviews":470,"dimensions":"16.2 x 25.5 cm (6 3/8 x 10 1/16 in.)\r\nframed: 38.1 x 47.9 x 8 cm (15 x 18 7/8 x 3 1/8 in.)","exhibitioncount":23,"dateend":1885,"creditline":"Harvard Art Museums/Fogg Museum, Bequest from the Collection of Maurice Wertheim, Class of 1906","imagepermissionlevel":0,"signed":"l.r.: Seurat","century":"19th century","medium":"Oil on panel","peoplecount":1,"accesslevel":1,"classification":"Paintings"};
var sample2 = {"accessionyear":null,"technique":null,"mediacount":0,"edition":null,"totalpageviews":474,"groupcount":0,"people":[{"birthplace":"Nolde, Germany","name":"Emil Nolde","prefix":null,"personid":27860,"role":"Artist","displayorder":1,"culture":"German","displaydate":"1867 - 1956","deathplace":"Seebüll, Germany","displayname":"Emil Nolde"}],"objectnumber":"BR54.117","colorcount":10,"lastupdate":"2014-10-02T04:42:11-0400","rank":139951,"imagecount":2,"description":null,"dateoflastpageview":"2014-09-30","dateoffirstpageview":"2009-05-13","primaryimageurl":"http://nrs.harvard.edu/urn-3:HUAM:78656_dynmc","colors":[{"percent":0.42988179669031,"spectrum":"#d0577c","color":"#7d3219","css3":"#8b4513","hue":"Orange"},{"percent":0.11338061465721,"spectrum":"#c25687","color":"#7d4b32","css3":"#8b4513","hue":"Brown"},{"percent":0.096973995271868,"spectrum":"#2eb45d","color":"#323232","css3":"#2f4f4f","hue":"Grey"},{"percent":0.085768321513002,"spectrum":"#3db657","color":"#321919","css3":"#000000","hue":"Brown"},{"percent":0.070732860520095,"spectrum":"#b65590","color":"#966464","css3":"#808080","hue":"Violet"},{"percent":0.064160756501182,"spectrum":"#a6549c","color":"#7d4b64","css3":"#696969","hue":"Violet"},{"percent":0.040236406619385,"spectrum":"#c25687","color":"#af7d7d","css3":"#bc8f8f","hue":"Red"},{"percent":0.032813238770686,"spectrum":"#e46867","color":"#966432","css3":"#a0522d","hue":"Orange"},{"percent":0.026335697399527,"spectrum":"#c15689","color":"#c89696","css3":"#bc8f8f","hue":"Red"},{"percent":0.011536643026005,"spectrum":"#5e6db3","color":"#4b6464","css3":"#696969","hue":"Blue"}],"dated":"1913","contextualtextcount":0,"copyright":"© Nolde Stiftung Seebüll, Germany","period":null,"url":"http://harvardartmuseums.org/art/223804","provenance":"Städtisches Museum Moritzburg, Halle, 1924, confiscated; by the Nazi government, 1937. Private collection, Germany, sold; [Feigl Gallery], 1954, sold; to Busch-Reisinger Museum, 1954.","images":[{"baseimageurl":"http://nrs.harvard.edu/urn-3:HUAM:78656_dynmc","primarydisplay":1,"publiccaption":null,"copyright":"President and Fellows of Harvard College","renditionnumber":"78656"},{"baseimageurl":"http://nrs.harvard.edu/urn-3:HUAM:13359_dynmc","primarydisplay":0,"publiccaption":null,"copyright":"President and Fellows of Harvard College","renditionnumber":"13359"}],"publicationcount":6,"objectid":223804,"culture":"German","verificationleveldescription":"Good. Object is well described and information is vetted","standardreferencenumber":null,"worktypes":[{"worktype":"painting"}],"department":"Busch-Reisinger Museum","state":null,"markscount":0,"contact":"am_moderncontemporary@harvard.edu","titlescount":2,"id":223804,"title":"The Mulatto","verificationlevel":3,"division":"Modern and Contemporary Art","style":null,"commentary":null,"relatedcount":0,"datebegin":1913,"totaluniquepageviews":276,"dimensions":"77.5 x 73 cm (30 1/2 x 28 3/4 in.)\r\nframed: 91.4 x 87.2 x 3 cm (36 x 34 5/16 x 1 3/16 in.)","exhibitioncount":7,"dateend":1913,"creditline":"Harvard Art Museums/Busch-Reisinger Museum, G. David Thompson Fund","imagepermissionlevel":1,"signed":"signed on recto at l.l.: Nolde","century":"20th century","medium":"Oil on canvas","peoplecount":1,"accesslevel":1,"classification":"Paintings"};		
var sample3 = {"accessionyear":"1951","technique":null,"mediacount":0,"edition":null,"totalpageviews":1030,"groupcount":0,"people":[{"birthplace":"Aix-en-Provence","name":"Paul Cézanne","prefix":null,"personid":31681,"role":"Artist","displayorder":1,"culture":"French","displaydate":"1839 - 1906","deathplace":"Aix-en-Provence","displayname":"Paul Cézanne"}],"objectnumber":"1951.46","colorcount":10,"lastupdate":"2014-10-05T04:15:42-0400","rank":78114,"imagecount":4,"description":null,"dateoflastpageview":"2014-10-04","dateoffirstpageview":"2009-05-14","primaryimageurl":"http://nrs.harvard.edu/urn-3:HUAM:DDC251910_dynmc","colors":[{"percent":0.58388888888889,"spectrum":"#3db657","color":"#323219","css3":"#2f4f4f","hue":"Brown"},{"percent":0.087444444444444,"spectrum":"#6cbd45","color":"#7d6432","css3":"#a0522d","hue":"Yellow"},{"percent":0.07,"spectrum":"#59ba4a","color":"#644b32","css3":"#556b2f","hue":"Brown"},{"percent":0.062666666666667,"spectrum":"#b55592","color":"#c8c8af","css3":"#c0c0c0","hue":"Green"},{"percent":0.052722222222222,"spectrum":"#8163ab","color":"#96af96","css3":"#8fbc8f","hue":"Green"},{"percent":0.048777777777778,"spectrum":"#7866ad","color":"#7d967d","css3":"#808080","hue":"Green"},{"percent":0.037944444444444,"spectrum":"#4fb94f","color":"#647d64","css3":"#696969","hue":"Green"},{"percent":0.023555555555556,"spectrum":"#5e6db3","color":"#4b6464","css3":"#696969","hue":"Blue"},{"percent":0.012888888888889,"spectrum":"#b65590","color":"#967d64","css3":"#808080","hue":"Brown"},{"percent":0.0094444444444444,"spectrum":"#9ecb3b","color":"#af9632","css3":"#cd853f","hue":"Yellow"}],"dated":"c. 1887-1888","contextualtextcount":0,"copyright":null,"period":null,"url":"http://harvardartmuseums.org/art/299841","provenance":"[Ambroise Vollard, Paris]. [Thannhauser, Munich]. [Paul Cassirer Gallery, Berlin].\r\nS. Fischer, Berlin, ( by 1918).\"R.P.A.\" (private collector), Paris, (1939).\r\n[Paul Rosenberg, Paris, (by 1939),sold];  to Maurice Wertheim, (1939 - 1951) bequest; to Fogg Art Museum, 1951.\r\n\r\nNotes:\r\nMeier-Graefe lists Fischer as owner in 1918. \r\n","images":[{"baseimageurl":"http://nrs.harvard.edu/urn-3:HUAM:DDC251910_dynmc","publiccaption":null,"displayorder":1,"copyright":"President and Fellows of Harvard College","renditionnumber":"DDC251910"},{"baseimageurl":"http://nrs.harvard.edu/urn-3:HUAM:DDC251916_dynmc","publiccaption":null,"displayorder":2,"copyright":"President and Fellows of Harvard College","renditionnumber":"DDC251916"},{"baseimageurl":"http://nrs.harvard.edu/urn-3:HUAM:LEG349_dynmc","publiccaption":null,"displayorder":3,"copyright":"President and Fellows of Harvard College","renditionnumber":"LEG349"},{"baseimageurl":"http://nrs.harvard.edu/urn-3:HUAM:80500_dynmc","publiccaption":null,"displayorder":4,"copyright":"President and Fellows of Harvard College","renditionnumber":"80500"}],"publicationcount":43,"objectid":299841,"culture":"French","verificationleveldescription":"Best. Object is extensively researched, well described and information is vetted","standardreferencenumber":null,"worktypes":[{"worktype":"painting"}],"department":"Department of Paintings, Sculpture & Decorative Arts","state":null,"markscount":4,"contact":"am_europeanamerican@harvard.edu","titlescount":1,"id":299841,"title":"Still Life with Commode","verificationlevel":4,"division":"European and American Art","style":null,"commentary":null,"relatedcount":2,"datebegin":1887,"totaluniquepageviews":648,"dimensions":"63.8 x 79.9 cm (25 1/8 x 31 7/16 in.)\r\nframed: 90.8 x 107 x 8.9 cm (35 3/4 x 42 1/8 x 3 1/2 in.)","exhibitioncount":26,"dateend":1888,"creditline":"Harvard Art Museums/Fogg Museum, Bequest from the Collection of Maurice Wertheim, Class of 1906","imagepermissionlevel":0,"signed":null,"century":"19th century","medium":"Oil on canvas","peoplecount":1,"accesslevel":1,"classification":"Paintings"};

addImage(sample1, order);
order++;
addImage(sample2, order);
order++;
addImage(sample3, order);


$(document).mousedown(function(options) {
	down = true;

	occur_once = false;
	var id = $(options.target).prev().attr("id");

	pointer.setCanvas(id);
	pointer.c = pointer.c;
	

	if(pointer.c.getActiveObject()) {
		active = pointer.c.getActiveObject();
		activeSet = activeObjs[active.get("orderid")];
		for(prop in activeSet) {
			activeSet[prop].bringToFront();
		}
		hover_elements();
	}

});


function hover_elements(){
	if(!active) return false;
	var extra = pointer.getIndex() * pointer.c.getWidth();

	
	var rightcorner_x = extra+active.left+active.getWidth()-50;
	var rightcorner_y = active.top+20;
	
	$(".closebutton").css({'left':rightcorner_x,'top':rightcorner_y})
		.bind( "click", function() {
			var order = active.get("orderid");
			$.each(canvases, function(i, c) {
				c.forEachObject(function(o) {
					console.log(o);
					if(o.get("orderid") == order) {
						o.remove();
					}
				});
			});
			
			$(".closebutton,.maxbutton").hide();
		});

	$(".maxbutton").css({'left':rightcorner_x,'top':rightcorner_y+60})
		.bind( "click", function() {
				if(!occur_once){
					$(".panel_zoom").show();
					console.log(activeSet["p1"]._originalElement.src);
					var zoom_mult = pzoom.width;
					fabric.Image.fromURL(activeSet["p1"]._originalElement.src, function(img) {
						img.set({
						//scaleX: zoom_mult,
						//scaleY: (canvas.height*zoom_mult)/F.height,
						width: zoom_mult,
						height: active.height * (zoom_mult/active.width),
						left: (zoom_mult-pzoom.width)/(-2),
						top: ((active.height * (zoom_mult/active.width))-pzoom.height)/(-2)
						});			
						pzoom.add(img).setActiveObject(img);
						activezoom = pzoom.getActiveObject();

					});

				$(".closebutton,.maxbutton").remove();
				$(".minbutton").css({'left':pzoom.width-50,'top':20}).show()
				.bind( "click", function() {
					////REMOVE LARGE DUPLICATE IMAGE
					if(pzoom.getActiveObject()){
					pzoom.getActiveObject().remove();
					}
					$(".panel_zoom").hide();

					///BRING BACK AND SHOW CLOSE/MAX BUTTONS
					$("body").append('<div class="closebutton"></div><div class="maxbutton"></div>');
					$(".minbutton").hide();
				});
				}occur_once = true;
			});

	$(".closebutton,.maxbutton").show();
	
}

///ON PLUS OR MINUS KEY, ZOOM IN OR OUT
window.addEventListener("keydown", function(e){
	///get old dimensions
	var w_old = activezoom.getWidth();
	var h_old = activezoom.getHeight();
	if (e.keyCode == PLUS) {
		console.log('zoomin');
		activezoom.scaleX += 0.05;
		activezoom.scaleY += 0.05;
	}
	if (e.keyCode == MINUS) {
		if(activezoom.getWidth()-(activezoom.getWidth()*0.05) > pzoom.width){
		console.log(activezoom.getWidth()-(activezoom.getWidth()*0.05)+ ' <= ' +pzoom.width+' can zoom out');
		activezoom.scaleX -= 0.05;
		activezoom.scaleY -= 0.05;
		}
	}
	//get new dimensions
	var w = activezoom.getWidth();
	var h = activezoom.getHeight();
	//center image frame
	activezoom.left = activezoom.left - (w - w_old)/2;
	activezoom.top = activezoom.top - (h - h_old)/2;

pzoom.renderAll();
	
	});


$(document).mousemove(function(e) {
	if(active) {
		if(pointer.r1id() && active.oCoords.br.x > pointer.c.width) {
			activeSet[pointer.r1id()].setVisible(true);
			activeSet[pointer.r1id()].setScaleX(active.getHeight() / activeSet[pointer.r1id()].height);
			activeSet[pointer.r1id()].setScaleY(active.getHeight() / activeSet[pointer.r1id()].height);
			activeSet[pointer.r1id()].setTop(active.getTop());
			
			var dx = pointer.c.width - active.oCoords.bl.x;
			activeSet[pointer.r1id()].setLeft(dx*-1);
			pointer.r1c().renderAll();
			
			if(pointer.r2id() && active.oCoords.br.x > pointer.c.width*2) {
				var diff = pointer.c.width*2 - active.oCoords.bl.x;
				console.log(diff);
				activeSet[pointer.r2id()].setVisible(true);
				activeSet[pointer.r2id()].setScaleX(active.getHeight() / activeSet[pointer.r2id()].height);
				activeSet[pointer.r2id()].setScaleY(active.getHeight() / activeSet[pointer.r2id()].height);
				activeSet[pointer.r2id()].setTop(active.getTop());
			
				var dx = pointer.c.width - active.oCoords.bl.x;
				activeSet[pointer.r2id()].setLeft(diff*-1);
				pointer.r2c().renderAll();	
			} else if(pointer.r2id()){
				activeSet[pointer.r2id()].setVisible(false);
				activeSet[pointer.r2id()].setTop(1000);
				pointer.r2c().renderAll();		
			}
				
		} 
		
		if(pointer.l1id() && active.oCoords.bl.x < 0) {
			activeSet[pointer.l1id()].setVisible(true);
			activeSet[pointer.l1id()].setScaleX(active.getHeight() / activeSet[pointer.l1id()].height);
			activeSet[pointer.l1id()].setScaleY(active.getHeight() / activeSet[pointer.l1id()].height);
			activeSet[pointer.l1id()].setTop(active.getTop());
			
			var dx = pointer.c.width + active.oCoords.bl.x;;
			activeSet[pointer.l1id()].setLeft(dx);
			pointer.l1c().renderAll();		
			
			if(pointer.l2id() && active.oCoords.bl.x < -1*pointer.c.width) {
				var diff = pointer.c.width + active.oCoords.bl.x;
				console.log(diff);
				activeSet[pointer.l2id()].setVisible(true);
				activeSet[pointer.l2id()].setScaleX(active.getHeight() / activeSet[pointer.l2id()].height);
				activeSet[pointer.l2id()].setScaleY(active.getHeight() / activeSet[pointer.l2id()].height);
				activeSet[pointer.l2id()].setTop(active.getTop());
			
				activeSet[pointer.l2id()].setLeft(pointer.c.width + diff);
				pointer.l2c().renderAll();	
			} else if(pointer.l2id()){
				activeSet[pointer.l2id()].setVisible(false);
				activeSet[pointer.l2id()].setTop(1000);
				pointer.l2c().renderAll();		
			}
		}		

		if(pointer.l1id() && active.oCoords.bl.x > 0) {
		
			activeSet[pointer.l1id()].setVisible(false);
			activeSet[pointer.l1id()].setTop(1000);
			pointer.l1c().renderAll();		
		}	

		if(pointer.r1id() && active.oCoords.br.x < pointer.c.width) {
			activeSet[pointer.r1id()].setTop(1000);
			activeSet[pointer.r1id()].setVisible(false);
			pointer.r1c().renderAll();		
		}	
			
	}
});



function refreshCoords() {
	for(var prop in activeSet) {
			activeSet[prop].setCoords();
	}
}

$(document).mouseup(function(options) {
	console.log("up");
	down = false;
	$.each(canvases, function(i, c) {
		c.calcOffset();
	});
		refreshCoords();

	hover_elements();
});



function addImage(objData, index) {
		var w = 200;
		var h;
		var obj = {};
		fabric.Image.fromURL("./art/"+objData.id+".jpg", function(oImg)
		{
			h = (oImg.getHeight() / oImg.getWidth()) * w;
			oImg.setWidth(w);
			oImg.setHeight(h);
			oImg.set("orderid", index);
			oImg.set("lockRotation",true);

			p1.add(oImg);
			obj.p1 = oImg;
	
			var group = new fabric.Group([], {left: 0, top: 0, width: w, height: h});
			group.set("orderid", index);
			group.set("lockRotation",true);
			group.setVisible(false);
			var hcount = 0;
			$.each(objData.colors, function(i, color) {
				var hx = h * color.percent;
				var rect = new fabric.Rect({
					left: -w/2,
					top: hcount - h/2,
					fill: color.color,
					width: w,
					height: hx
				});
					hcount += hx;
					group.add(rect);
			});
		
			p3.add(group);
			obj.p3 = group;
			
		});
		
		fabric.Image.fromURL("./art/"+objData.id+".jpg", function(oImg)
		{
			h = (oImg.getHeight() / oImg.getWidth()) * w;

			oImg.setWidth(w);
			oImg.setHeight(h);
			oImg.set("orderid", index);
			oImg.set("lockRotation",true);
			oImg.setLeft(-w/2);
			oImg.setTop(-1.5*h);
			RGBify(oImg, 0);

			oImg.setVisible(false);
			p5.add(oImg);
			obj.p5 = oImg;

		

			var p4group = new fabric.Group([], {left: 0, top: 0, width: w, height: h});
			p4group.set("orderid", index);

			for(var j=0; j < objData.images.length; j++) {			
				addImageSync(objData.images[j].baseimageurl, j, w, h, objData.images.length, p4group);
			}
			p4group.count = objData.images.length - 1;
			p4group.curr = p4group.count;
			p4group.setVisible(false);
			p4.add(p4group);
			obj.p4 = p4group;
			p4.renderAll()
				
		});
	
	
	fabric.Image.fromURL("./art/"+objData.id+".jpg", function(oImg)
		{
			h = (oImg.getHeight() / oImg.getWidth()) * w;

			oImg.setWidth(w);
			oImg.setHeight(h);
			oImg.set("orderid", index);
			oImg.set("lockRotation",true);
			oImg.setLeft(-w/2);
			oImg.setTop(-1.5*h);
			Pixelate(oImg, 25)
			oImg.setVisible(false);
			p2.add(oImg);
			obj.p2 = oImg;

		});				
		
		activeObjs.push(obj);	
		
}

function addImageSync(url, index, w, h, lim, group) {
	fabric.Image.fromURL(url, function(oImg2)
		{
			var h2 = (oImg2.getHeight() / oImg2.getWidth()) * w;
			var w2 = w;
			if (h2 > h ) {
				h2 = h;
				w2 = (h2/oImg2.getHeight())*oImg2.getWidth();
			}
			oImg2.setWidth(w2);
			oImg2.setHeight(h2);
			oImg2.set("lockRotation",true);
			oImg2.setLeft(-w2/2);
			oImg2.setTop(-h2/2);
			if(index == lim-1) oImg2.setVisible(true);	
			else 	oImg2.setVisible(false);
			group.add(oImg2);

		});		
}

function RGBify(obj, num) {
	switch(num) {
		case 0:
			obj.filters = [new fabric.Image.filters.Redify()];
			obj.next = 1;
			obj.prev = 2;
			break;
		case 1:
			obj.filters = [new fabric.Image.filters.Greenify()];
			obj.next = 2;
			obj.prev = 0;
			break;
		case 2:
			obj.filters = [new fabric.Image.filters.Blueify()];
			obj.next = 0;
			obj.prev = 1;
			break;
	}
	obj.applyFilters(p5.renderAll.bind(p5));
}

function Pixelate(obj, num) {
	obj.filters = [new fabric.Image.filters.Pixelate({
      blocksize: num
    })];
	
	obj.applyFilters(p2.renderAll.bind(p2));
}

var LEFT = 37;
var UP = 38;
var RIGHT = 39;
var DOWN = 40;

window.addEventListener("keydown", function(e) //window
{
	//e = e || window.event;
	if(pointer.c == p2) {
			if (e.keyCode == UP && active.filters[0].blocksize > 5) Pixelate(active, active.filters[0].blocksize - 5);
			else if (e.keyCode == DOWN && active.filters[0].blocksize < 80) {
				Pixelate(active, active.filters[0].blocksize +5);
				return false;
			}
	} else if(pointer.c == p1) {
			if (e.keyCode == UP && active.opacity < 1) {
				active.setOpacity(active.opacity + .1 );
				p1.renderAll();
			} else if(e.keyCode == DOWN && active.opacity > .2) {
				active.setOpacity(active.opacity - .1 );
				p1.renderAll();
			}
	} else if(pointer.c == p5) {
			if (e.keyCode == UP) {
				RGBify(active, active.next);
			} else if(e.keyCode == DOWN) {
				RGBify(active, active.prev);
			}		
	} else if(pointer.c == p4) {
			if (e.keyCode == UP) {
				active.getObjects()[active.curr].setVisible(false);
				var next = active.curr + 1;
				if (next > active.count) next = 0;
				active.getObjects()[next].setVisible(true);
				active.curr = next;
				p4.renderAll();
			} else if(e.keyCode == DOWN) {
				active.getObjects()[active.curr].setVisible(false);
				var prev = active.curr - 1;
				if (prev < 0) prev = active.count;
				active.getObjects()[prev].setVisible(true);
				active.curr = prev;
				p4.renderAll();
			}		
	}
	
});

function canvasPointer() {
	this._index = 0;
	this.cid = "p1";
	this.c = p1;
	var cids = ["p1","p2","p3","p4","p5",];
	var canvases = [p1, p2, p3, p4, p5];
	this.activateNext = function() {
		this._index++;
		this.cid = cids[this._index];
		this.c = canvases[this._index];
	};
	this.activatePrev = function() {
		this._index--;
		this.cid = cids[this._index];
		this.c = canvases[this._index];
	};
	this.r1id = function() {
		if(this._index == 4) return false;
		return cids[this._index+1];
	};
	this.r2id = function() {
		if(this._index == 3) return false;
		return cids[this._index+2];
	};
	this.l1id = function() {
		if(this._index == 0) return false;
		return cids[this._index-1];
	}	;
	this.l2id = function() {
		if(this._index == 1) return false;
		return cids[this._index-2];
	};
	this.r1c = function() {
		if(this._index == 4) return false;
		return canvases[this._index+1];
	};
	this.r2c = function() {
		if(this._index == 3) return false;
		return canvases[this._index+2];
	};
	this.l1c = function() {
		if(this._index == 0) return false;
		return canvases[this._index-1];
	}	;
	this.l2c = function() {
		if(this._index == 1) return false;
		return canvases[this._index-2];
	};
	this.setCanvas = function(cid) {
		var i = cids.indexOf(cid);
		if(i == -1) return false;
		this.cid = cid;
		this.c = canvases[i];
		this._index = i;
	};
	this.getIndex = function() {
		return this._index;
	}
}

</script>



	</body>
</html>