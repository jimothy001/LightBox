<!DOCTYPE html>
<html>
	<head>

		<title>SANDBOX</title>
		<script type="text/javascript" src="lib/jquery-1.8.2.js" ></script>  
		<script type="text/javascript" src="lib/fabric.js"></script>
		<link href='http://fonts.googleapis.com/css?family=Inconsolata' rel='stylesheet' type='text/css'>
	<style>
		#sandbox 
		{
			width: 3100px;
			height:900px;
			background-color: white;
			position: relative;
			float: left;
			display: block;
			border: 1px solid black;
		}
		
		
		#panels .canvas-container {
			float:left;
			position: 'relative'
		}
		
		#tray {
			clear: both;
			margin: 25px 10px 0 10px;
		}
		
		#tray-container {
			clear: both;
		}
		
		html,body {
			font-size: 12px;
			font-family: arial;
			margin: 0;
			padding: 0;
		}
		
		.closebutton, .maxbutton, .metabutton, .minbutton{
			position: absolute;
			z-index: 999;
			display: none;
			border-radius: 50%;
		    width: 40px;
		    height: 40px;
		    border: 3px solid #fff;
		    color: white;
		}
		.closebutton:hover, .metabutton:hover, .maxbutton:hover, .minbutton:hover{
			cursor: pointer;
		}
		.closebutton{
		    background: url('img/icon_close.png');
		}
		.maxbutton{
		    background: url('img/icon_max.png');
		}
		.metabutton{
		    background: url('img/icon_meta.png');
		}
		.minbutton{
		    background: url('img/icon_min.png');
		}
		.metainfo{
			position: absolute;
			z-index: 999;
			/*background: white;*/
			background: url('img/backtranslucent.png');
			display: none;
			width: 40px;
		  height: 40px;
		  overflow:hidden;
		}
		.metainfo div{
			margin: 5px;
		}
		.panel{
			border: 1px solid #ccc;
		}
		
		
		.panel_zoom{
			margin: 10px;
			position: absolute;
			top: 0;
			left: 0;
			display: none;
			border: 1px solid #ccc;
		}
		.divider div{
			height: 800px;
			width: 75px;
			border-left: 1px solid #ccc;
			border-right: 1px solid #ccc;
			background: white;
			position: absolute;
			top: 10px;
			z-index: 99999;
		}
		
		.divider div.left {
			border-right: none;

		}
		
		.divider div:nth-child(1) {left: 700px;}
		.divider div:nth-child(2) {left: 1475px; width: 50px;}
		.divider div:nth-child(3) {left: 2225px;}
		.divider div:nth-child(4) {left: 3000px;}
	</style>
	</head>
	
	<body>
		<div class="closebutton"></div>
		<div class="maxbutton"></div>
		<div class="metabutton"></div>
		<div class="minbutton"></div>
		<div class="metainfo"></div>

<div class='divider'>
<div></div>
<div></div>
<div></div>
<div class="left"></div>
</div>

	<div id="panels">
		<!-- <div id="metadata"></div> -->
		<canvas id="p1" class="panel a" width="700" height="800"></canvas>
		<canvas id="p2" class="panel b" width="700" height="800"></canvas>
		<canvas id="p3" class="panel a" width="700" height="800"></canvas>
		<canvas id="p4" class="panel" width="700" height="800"></canvas>
	</div>

	<div id="tray-container">
		<canvas id="tray" class="tray" width="3000" height="50"></canvas>
	</div>

		<div class="panel_zoom">
			<canvas id="pzoom" width="3000" height="800"></canvas>	
		</div>
		

		<script type="text/javascript" src="sandbox_channels.js"></script>
		<script src="/socket.io/socket.io.js"></script> 
		<script src="https://cdn.socket.io/socket.io-1.0.6.js"></script>

<script>


var p1 = new fabric.Canvas("p1");
var p2 = new fabric.Canvas("p2");
var p3 = new fabric.Canvas("p3");
var p4 = new fabric.Canvas("p4");


var pointer = new canvasPointer();
var canvases = [p1, p2, p3, p4];

$.each(canvases, function(i, c) {
	var x = 75;
	if(i==1) x = 50;
	if(i==3) x=0;
	$(c.wrapperEl).css("margin-right", x);
});

var order = 0;

var pzoom = new fabric.Canvas("pzoom");
var zoom = false;

//keycodes
var PLUS = 187;
var MINUS = 189;
var LEFT = 37;
var UP = 38;
var RIGHT = 39;
var DOWN = 40;
// end keycodes

var image_metadata = [];
var activeObjs = [];
var dbObjs = [];
var activeSet = null;
var trayCount = 0;

var activezoom;
var active;

var curr = false;

var down = false;

var occur_once = false;

var tray = new fabric.Canvas("tray");
var socket = io();
socket.emit('get-items', {});

socket.on('send-items', function(data)
{
	dbObjs = data;
	addToTray(0);
});

socket.on('updated-db', function(data)
{
	dbObjs.push(data);
	//trayCount = 0;
	addAndShift();
});

function grabArt(id) {
	$.get("http://api.harvardartmuseums.org/object/"+id+"?apikey=f5473230-3f68-11e4-89b4-73adcea7266b", function(art) {
		if(art.related) console.log(art.related);
		addImage(art, order);
		metaImage(art, order);
		order++;
	});	
}




/*
	add object's metadata to global var
*/
function metaImage(objData, index) {
		//check for duplicates
		var dup_object = false;
		for(var i in image_metadata) {
			if(image_metadata[i].objectid == objData.objectid){
			console.log(image_metadata[i]);
			dup_object = true;
			}					
		}
		if(!dup_object){
			image_metadata.push(objData);
		}else{
			console.log('object exists already');
		}

};

/*
$(document).mousedown(function(options) {
	down = true;
	refreshCoords();
});*/

$(document).mousedown(function(options) {
	down = true;

	occur_once = false;
	var id = $(options.target).prev().attr("id");

	pointer.setCanvas(id);

	if(pointer.c.getActiveObject()) {
		active = pointer.c.getActiveObject();

		activeSet = activeObjs[active.get("orderid")];
		
		$.each(canvases, function(i,c) {
			if(c.getActiveObject() && c != pointer.c) {
				c.getActiveObject().active = false;
				c.renderAll();
			}
		});
			
		for(prop in activeSet) {
			activeSet[prop].bringToFront();
		}
		hover_elements();
		
	} else {
		active = false;
		activeSet = false;
	}
});


function hover_elements(){
	if(!active) return false;
	var extra = pointer.getExtra();

	
	var rightcorner_x = extra+active.left+active.getWidth()-65;
	var rightcorner_y = active.top+20;
	
	$(".closebutton").css({'left':rightcorner_x,'top':rightcorner_y})
		.bind( "click", function() {
			if(!activeSet) return false;
			var order = active.get("orderid");
			for(prop in activeSet) {
				if(activeSet[prop]._objects) {
					while(activeSet[prop]._objects.length > 0) {
						activeSet[prop].remove(activeSet[prop]._objects[0]);
					}
				} 
				
				activeSet[prop].canvas.remove(activeSet[prop]);
				
			}
			activeSet = false;
			active = false;
			
			$(".closebutton,.maxbutton,.metabutton").hide();
		});

	$(".maxbutton").css({'left':rightcorner_x-55,'top':rightcorner_y})
		.bind( "click", function() {

				if(!occur_once){
					///SHOW LARGE ZOOM DIV
					$(".panel_zoom").show();
					zoom = true;
					console.log(activeSet["p1"]._originalElement.src);
					var zoom_mult = pzoom.width;
					fabric.Image.fromURL(activeSet["p1"]._originalElement.src, function(img) {
						img.set({
						//scaleX: zoom_mult,
						//scaleY: (canvas.height*zoom_mult)/F.height,
						width: zoom_mult,
						height: active.height * (zoom_mult/active.width),
						left: (zoom_mult-pzoom.width)/(-2),
						top: ((active.height * (zoom_mult/active.width))-pzoom.height)/(-2)
						});			
						pzoom.add(img).setActiveObject(img);
						activezoom = pzoom.getActiveObject();
					});



				$(".closebutton,.maxbutton,.metabutton").remove();
				$(".minbutton").css({'left':pzoom.width-50,'top':20}).show()
				.bind( "click", function() {
					////REMOVE LARGE DUPLICATE IMAGE
					if(pzoom.getActiveObject()){
					//	pzoom.remove(pzoom.getActiveObject());
						pzoom.clear();
					}
					///HIDE LARGE ZOOM DIV
					$(".panel_zoom").hide();
					zoom = false;

					///BRING BACK AND SHOW CLOSE/MAX BUTTONS
					$("body").append('<div class="closebutton"></div><div class="maxbutton"></div><div class="metabutton"></div>');
					$(".minbutton").hide();
				});
				//}occur_once = true;
			}
		});

	$(".metabutton").css({'left':extra+active.left+20,'top':rightcorner_y})
			.bind( "click", function() {
				$(".metainfo").css({'left':extra+active.left+14,'top':active.top+14,'width':active.getWidth()-6,'height':active.getHeight()-6});
				//if(!occur_once){
			
					
					var image_id = active.get("objid");
					//console.log(image_id);
					var meta_info;
					/// MATCH OBJECT ID WITH OBJECT ID IN ARRAY, GET METADATA INFO
					for(var i in image_metadata) {
							if(image_metadata[i].objectid == image_id){
								//console.log(image_metadata[i]);
								meta_info = "<div>";
								meta_info += "<span><b>id:</b> "+image_metadata[i].objectid+"</span>"+"</br>";
								meta_info += "<span><b>date:</b> "+image_metadata[i].dated+"</span>"+"</br>";
								meta_info += "<span><b>century:</b> "+image_metadata[i].century+"</span>"+"</br>";
								meta_info += "<span><b>culture:</b> "+image_metadata[i].culture+"</span>"+"</br>";
								meta_info += "<span><b>accessioned:</b> "+image_metadata[i].accessionyear+"</span>"+"</br>";
								meta_info += "<span><b>description:</b> "+image_metadata[i].description+"</span>"+"</br>";
								meta_info += "</div>";
							}
					}					
					$(".metainfo").show().html(meta_info);
					$(".closebutton,.metabutton,.maxbutton").hide();
					//ON CLICK ANYWHERE, HIDE METADATA
					$(window).mousedown(function() {
						$(".metainfo").hide();
						$(".closebutton,.metabutton,.maxbutton").show();
						occur_once = false;
					});

					
				//}occur_once = true;
			});
	$(".closebutton,.metabutton,.maxbutton").show();
	
}

/*
///ON PLUS OR MINUS KEY, ZOOM IN OR OUT
window.addEventListener("keydown", function(e){
	///get old dimensions
	if(!zoom) return false;
	var w_old = activezoom.getWidth();
	var h_old = activezoom.getHeight();
	if (e.keyCode == PLUS) {
		//console.log('zoomin');
		activezoom.scaleX += 0.05;
		activezoom.scaleY += 0.05;
	}
	if (e.keyCode == MINUS) {
		if(activezoom.getWidth()-(activezoom.getWidth()*0.05) > pzoom.width){
		//console.log(activezoom.getWidth()-(activezoom.getWidth()*0.05)+ ' <= ' +pzoom.width+' can zoom out');
		activezoom.scaleX -= 0.05;
		activezoom.scaleY -= 0.05;
		}
	}
	//get new dimensions
	var w = activezoom.getWidth();
	var h = activezoom.getHeight();
	//center image frame
	activezoom.left = activezoom.left - (w - w_old)/2;
	activezoom.top = activezoom.top - (h - h_old)/2;

	pzoom.renderAll();
	
});
*/


////MAX WINDOW PANNING BOUNDARIES
pzoom.on('object:moving', function(options) {
  if (options.target) {
    //console.log('object is moving');
    if(activezoom.left >= 0){
    //console.log('hit edge_left!');
    activezoom.left = 0;
    }
    if(parseInt(activezoom.left+activezoom.getWidth()) <= pzoom.width){
    //console.log('hit edge_right!');
    activezoom.left = (-1*activezoom.getWidth())+pzoom.width;
    }
    if(activezoom.top >= 0){
    //console.log('hit edge_top!');
    activezoom.top = 0;
    }
    if(parseInt(activezoom.top+activezoom.getHeight()) <= pzoom.height){
    //console.log('hit edge_bottom!');
    activezoom.top = (-1*activezoom.getHeight())+pzoom.height;
    }
  }
});



///ON PLUS OR MINUS KEY, ZOOM IN OR OUT
window.addEventListener("keydown", function(e){
	///IF MAX/ZOOM WINDOW CLOSED
   	var elem_zoom;
    if ($(".panel_zoom").css('display') == 'none'){
       elem_zoom = active;
       	if (e.keyCode == UP) {
					console.log('zoomin');
					elem_zoom.scaleX += 0.05;
					elem_zoom.scaleY += 0.05;
				} else if (e.keyCode == DOWN) {
					console.log("zoom out");
					elem_zoom.scaleX -= 0.05;
					elem_zoom.scaleY -= 0.05;				
				}
				
				pointer.renderAll()
				active.setCoords();
				onMove();
				pointer.renderAll()
				hover_elements();
       
       
    }else{
	///IF MAX/ZOOM WINDOW OPEN, ZOOM MAX WINDOW
		elem_zoom = activezoom;
	}

	///get old dimensions
	var w_old = elem_zoom.getWidth();
	var h_old = elem_zoom.getHeight();
	if (e.keyCode == UP) {
		//console.log('zoomin');
		elem_zoom.scaleX += 0.05;
		elem_zoom.scaleY += 0.05;
	}
	
	if (e.keyCode == DOWN) {
		if(elem_zoom.getWidth()-(elem_zoom.getWidth()*0.05) > pzoom.width){
		console.log(elem_zoom.getWidth()-(elem_zoom.getWidth()*0.05)+ ' <= ' +pzoom.width+' can zoom out');
		elem_zoom.scaleX -= 0.05;
		elem_zoom.scaleY -= 0.05;
		}
	}

	//get new dimensions
	var w = elem_zoom.getWidth();
	var h = elem_zoom.getHeight();
	//center image frame
	elem_zoom.left = elem_zoom.left - (w - w_old)/2;
	elem_zoom.top = elem_zoom.top - (h - h_old)/2;

	pzoom.renderAll();
	
});





var prev = 0;

$(document).mousemove(function(e) {
		if(!active) return false;
		var found = false;

		if(active) {
			active.setCoords();
			pointer.c.calcOffset();
		}
		refreshCoords();
		var c;
		if(!$(e.target).hasClass("upper-canvas")) {
			return false;
		} else 	{
			c = e.target.parentElement.children[0];
			
				if(e.offsetX > activeSet[c.id].oCoords.bl.x && e.offsetX < activeSet[c.id].oCoords.br.x) {
					if(e.offsetY < activeSet[c.id].oCoords.bl.y && e.offsetY > activeSet[c.id].oCoords.tl.y) {
						
						if(activeSet[c.id].visible) {
							active = activeSet[c.id];
							pointer.setCanvas(c.id);
							found = true;
						}
					}
				}
			
			//return false;
			
			/*if(c.id != pointer.cid) {
				console.log("new canvas");
				pointer.setCanvas(c.id);
				console.log(pointer.c);
				if(activeSet) active = activeSet[c.id]
				else console.log("no active");
				found = true;

			}*/
			
		/*	$.each(pointer.c.getObjects(), function(i, obj) {
				if(e.offsetX > obj.oCoords.bl.x && e.offsetX < obj.oCoords.br.x) {
					if(e.offsetY < obj.oCoords.bl.y && e.offsetY > obj.oCoords.tl.y) {
						
						if(obj != active) {
							pointer.c.setActiveObject(obj);
							active = obj;
							activeSet = activeObjs[active.get("orderid")];
							active.setCoords();
							pointer.c.calcOffset();
							//pointer.c.renderAll();
							console.log("new object");
							console.log(obj);
							found = true;

						} 
					}
				}
			});*/
		
			if(!found) return false;

			console.log(active.oCoords.br.x);	

	
			if(active && activeSet) {
				
				for(prop in activeSet) {
					activeSet[prop].bringToFront();
				}
				hover_elements();
		
				onMove();
		
				active.setCoords();
				pointer.c.calcOffset();
				console.log(active.oCoords.br.x);
				if(active.oCoords.br.x == prev) {
					console.log("same");
					console.log(pointer.cid);
					console.log(active);
				}
				prev = active.oCoords.br.x;
				if(active.oCoords.tl.y > 800) {
					console.log("offscreen");
				}
			}
	}
});
	
function onMove(e) {
		if(pointer.firstRightID() && active.oCoords.br.x > pointer.c.width) {
			var objModR = activeSet[pointer.firstRightID()];
			objModR.setVisible(true);
			objModR.canvas.setActiveObject(objModR);
	
			objModR.setScaleX(active.getHeight() / objModR.height);
			objModR.setScaleY(active.getHeight() / objModR.height);
			objModR.setTop(active.getTop());
	
			var dx = pointer.c.width - active.oCoords.bl.x;
			objModR.setLeft(dx*-1);
			//	pointer.FirstRightCanvas().renderAll();
			objModR.setCoords();
	
			if(pointer.SecondRightID() && active.oCoords.br.x > pointer.c.width*2) {
				var objModR2 = activeSet[pointer.SecondRightID()];			
				var diff = pointer.c.width*2 - active.oCoords.bl.x;
				objModR2.setVisible(true);
				objModR2.canvas.setActiveObject(objModR2);
		
				objModR2.setScaleX(active.getHeight() / objModR2.height);
				objModR2.setScaleY(active.getHeight() / objModR2.height);
				objModR2.setTop(active.getTop());
	
				var dx = pointer.c.width - active.oCoords.bl.x;
				objModR2.setLeft(diff*-1);
				//	pointer.SecondRightCanvas().renderAll();	
				objModR2.setCoords();
	
	
				if(pointer.ThirdRightID() && active.oCoords.br.x > pointer.c.width*3) {
						var objModR3 = activeSet[pointer.ThirdRightID()];
						var diff = pointer.c.width*3 - active.oCoords.bl.x;
						objModR3.canvas.setActiveObject(objModR3);

						objModR3.setVisible(true);
						objModR3.setScaleX(active.getHeight() / objModR3.height);
						objModR3.setScaleY(active.getHeight() / objModR3.height);
						objModR3.setTop(active.getTop());
	
						var dx = pointer.c.width - active.oCoords.bl.x;
						objModR3.setLeft(diff*-1);
					//	pointer.ThirdRightCanvas().renderAll();		
						objModR3.setCoords();
					
				} else if(pointer.ThirdRightID()) {
					activeSet[pointer.ThirdRightID()].active = false;
					activeSet[pointer.ThirdRightID()].setVisible(false);
					activeSet[pointer.ThirdRightID()].setTop(1000);
			//		pointer.ThirdRightCanvas().renderAll();				
				}
		
			} else if(pointer.SecondRightID()){
				activeSet[pointer.SecondRightID()].active = false;		
				activeSet[pointer.SecondRightID()].setVisible(false);
				activeSet[pointer.SecondRightID()].setTop(1000);
			//	pointer.SecondRightCanvas().renderAll();		
			}
		
		} 

		if(pointer.FirstLeftID() && active.oCoords.bl.x < 0) {
			var objModL = activeSet[pointer.FirstLeftID()];
			objModL.setVisible(true);
			objModL.canvas.setActiveObject(objModL);
	
			objModL.setScaleX(active.getHeight() / objModL.height);
			objModL.setScaleY(active.getHeight() / objModL.height);
			objModL.setTop(active.getTop());
	
			var dx = pointer.c.width + active.oCoords.bl.x;
			objModL.setLeft(dx);
	//		pointer.FirstLeftCanvas().renderAll();	
			objModL.setCoords();	
	
			if(pointer.SecondLeftID() && active.oCoords.bl.x < -1*pointer.c.width) {
				var objModL2 = activeSet[pointer.SecondLeftID()];
				objModL2.canvas.setActiveObject(objModL2);
		
				var diff = pointer.c.width + active.oCoords.bl.x;
				objModL2.setVisible(true);
				objModL2.setScaleX(active.getHeight() / objModL2.height);
				objModL2.setScaleY(active.getHeight() / objModL2.height);
				objModL2.setTop(active.getTop());
	
				objModL2.setLeft(pointer.c.width + diff);
			//	pointer.SecondLeftCanvas().renderAll();	
				objModL2.setCoords();
		
				if(pointer.ThirdLeftID() && active.oCoords.bl.x < -2*pointer.c.width) {
					var objModL3 = activeSet[pointer.ThirdLeftID()];
					objModL3.canvas.setActiveObject(objModL3);
					var diff = pointer.c.width + active.oCoords.bl.x;

					objModL3.setVisible(true);
					objModL3.setScaleX(active.getHeight() / objModL3.height);
					objModL3.setScaleY(active.getHeight() / objModL3.height);
					objModL3.setTop(active.getTop());
	
					objModL3.setLeft(2*pointer.c.width + diff);
				//	pointer.ThirdLeftCanvas().renderAll();	
					objModL3.setCoords();
						
				} else if(pointer.ThirdLeftID()) {
					activeSet[pointer.ThirdLeftID()].active = false;
					activeSet[pointer.ThirdLeftID()].setVisible(false);
					activeSet[pointer.ThirdLeftID()].setTop(1000);
					pointer.ThirdLeftCanvas().renderAll();				
				}				
		
			} else if(pointer.SecondLeftID()){
				activeSet[pointer.SecondLeftID()].active = false;
				activeSet[pointer.SecondLeftID()].setVisible(false);
				activeSet[pointer.SecondLeftID()].setTop(1000);
				pointer.SecondLeftCanvas().renderAll();		
			}
		}		

		if(pointer.FirstLeftID() && active.oCoords.bl.x > 0) {
			activeSet[pointer.FirstLeftID()].active = false;
			activeSet[pointer.FirstLeftID()].setVisible(false);
			activeSet[pointer.FirstLeftID()].setTop(1000);
			pointer.FirstLeftCanvas().renderAll();		
		}	

		if(pointer.firstRightID() && active.oCoords.br.x < pointer.c.width) {
			activeSet[pointer.firstRightID()].active = false;
			activeSet[pointer.firstRightID()].setTop(1000);
			activeSet[pointer.firstRightID()].setVisible(false);
			pointer.FirstRightCanvas().renderAll();		
		}	
	
	
	if(active) active.setCoords();
	pointer.c.calcOffset();
	
}




function refreshCoords() {
	for(var prop in activeSet) {
		activeSet[prop].setCoords();
	}
	$.each(canvases, function(i,c) {
		c.calcOffset();
	});
}

$(document).mouseup(function(options) {
	//console.log("mouse_up");
	down = false;
	$.each(canvases, function(i, c) {
		c.calcOffset();
	});
	refreshCoords();

	hover_elements();
});


var imgCount = 0;
function addImage(objData, index) {
		var w = 500;
		var h;
		var obj = {};
		
		fabric.Image.fromURL("./art/"+objData.id+".jpg", function(oImg)
		{
			h = (oImg.getHeight() / oImg.getWidth()) * w;
			oImg.setWidth(w);
			oImg.setHeight(h);
			oImg.set("orderid", index);
			oImg.set("objid", objData.id);
			oImg.set("lockRotation",true);
			oImg.set("lockScalingX",true);
			oImg.set("lockScalingY",true);
			oImg.on("scaling", function() {
				console.log("move");
				onMove();
			});
			
			p1.add(oImg);
			obj.p1 = oImg;
			
		});
		
		fabric.Image.fromURL("./art/"+objData.id+".jpg", function(oImg)
		{
			h = (oImg.getHeight() / oImg.getWidth()) * w;
			oImg.setWidth(w);
			oImg.setHeight(h);
			oImg.set("orderid", index);
			oImg.set("objid", objData.id);
			oImg.set("lockRotation",true);
			oImg.set("lockScalingX",true);
			oImg.set("lockScalingY",true);
			oImg.setLeft(-w/2);
			oImg.setTop(-1.5*h);
			Pixelate(oImg, 25)
			oImg.setVisible(false);
			p2.add(oImg);
			obj.p2 = oImg;
			var max = Math.floor(w/6.4);
			var lcount = Math.floor(h/12);
			var newstring = getMetaData(objData, max, lcount);
			
			console.log(newstring);
			var text = new fabric.Text(newstring, {left: -w/2, top: -1.5*h, width: w, height: h*3});
			text.set("orderid", index);
			text.set("lockRotation",true);
			text.set("lockScalingX",true);
			text.set("lockScalingY",true);
			text.set("objid", objData.id);
			text.setFontSize(10);
			text.setFontWeight(100);
			text.setFontFamily('Inconsolata');
			text.setLineHeight(1);
			text.setVisible(false);
			text.set("max", max);
			text.set("lcount", lcount);
			p3.add(text);
			obj.p3 = text;
			
			var p4group = new fabric.Group([], {left: 0, top: 0, width: w, height: h});
			p4group.set("orderid", index);
			p4group.set("objid", objData.id);
			p4group.set("lockRotation",true);
			p4group.set("lockScalingX",true);
			p4group.set("lockScalingY",true);
			imgCount = 0;
			for(var j=0; j < objData.images.length; j++) {			
				addImageSync(objData.images[j].baseimageurl, w, h, objData.images.length, p4group);
			}
			p4group.count = objData.images.length - 1;
			p4group.curr = p4group.count;
			p4group.setVisible(false);
			p4.add(p4group);
			obj.p4 = p4group;
			p4.renderAll()
			
		});
		activeObjs.push(obj);	
		
}


function addAndShift() {
		var h = 50;
		var w;
		fabric.Image.fromURL("./art/" +dbObjs[dbObjs.length-1].objectid + ".jpg", function(oImg)
			{
				w = (h/oImg.getHeight())*oImg.getWidth();			
				
				oImg.setWidth(w);
				oImg.setHeight(h);		
				oImg.set("lockRotation",true);
				oImg.setTop(0);
				oImg.setLeft(-1*w);
				oImg.set("selectable", false);
				oImg.set("order", dbObjs.length-1);
				tray.add(oImg);
				
				$.each(tray.getObjects(), function(i, o) {
					o.setLeft(o.getLeft()+w);
					dbObjs[o.get("order")].x1 = o.getLeft();
					dbObjs[o.get("order")].x2 = o.getLeft() + o.getWidth();
				
				
				});
				tray.renderAll()
								
		});


}

function addToTray(index) {
		var h = 50;
		var w;
		fabric.Image.fromURL("./art/" +dbObjs[index].objectid + ".jpg", function(oImg)
			{
				w = (h/oImg.getHeight())*oImg.getWidth();
				oImg.setWidth(w);
				oImg.setHeight(h);		
				oImg.set("lockRotation",true);
				oImg.setTop(0);
				oImg.setLeft(-100);
				dbObjs[index].x1 = trayCount;			
				oImg.set("selectable", false);
				oImg.set("order", index);
				tray.add(oImg);
				var dx = 100+trayCount;
			
				oImg.animate('left', '+='+dx, {
					duration: 1000,
					onChange: tray.renderAll.bind(tray),
					onComplete: function() {
						trayCount += (w+5);			
						dbObjs[index].x2 = trayCount;
						if((index < dbObjs.length - 1) && trayCount < tray.getWidth()) addToTray(index+1);
					},
					easing: fabric.util.ease["easeOutExpo"]
				});
				
		});
}

	

$("#tray-container").on("click", function(e) {
	$.each(dbObjs, function(i,val) {
		if(e.offsetX > val.x1 && e.offsetX < val.x2) {
			console.log(val.objectid);
			grabArt(val.objectid);	
		}
	});
});

function getMetaData(objData, max, lcount) {
	var mdstring = JSON.stringify(objData);
	var newstring = "";
	var l1,l2 = 0;

	
	var buff = lcount*max;
	console.log(buff);
	console.log(mdstring.length);
	
	l1 = Math.floor(Math.random()*(mdstring.length - buff));
	l2 = l1+buff;
	console.log(l1);
	
	//full metadata character count:
	//max = Math.floor(Math.sqrt((mdstring.length*1.4*w)/h));
	var count = 0;
	while(count<lcount) {
	
		var chunk = mdstring.substr(l1, max);
		console.log(chunk.length);
		newstring += chunk;
		newstring += "\n";
	
		l1 += max;
		count++;
	
	}
	return newstring;

}


function addImageSync(url, w, h, lim, group) {
	fabric.Image.fromURL(url, function(oImg2)
		{
			var h2 = (oImg2.getHeight() / oImg2.getWidth()) * w;
			var w2 = w;
			if (h2 > h ) {
				h2 = h;
				w2 = (h2/oImg2.getHeight())*oImg2.getWidth();
			}
			oImg2.setWidth(w2);
			oImg2.setHeight(h2);
			oImg2.set("lockRotation",true);
			oImg2.setLeft(-w2/2);
			oImg2.setTop(-h2/2);
			if(imgCount == lim-1) {
				console.log(lim);
				console.log(imgCount);
				oImg2.setVisible(true);	
			}
			else oImg2.setVisible(false);
			group.add(oImg2);
			imgCount++;

		});		
}

function RGBify(obj, num) {
	switch(num) {
		case 0:
			obj.filters = [new fabric.Image.filters.Redify()];
			obj.next = 1;
			obj.prev = 2;
			break;
		case 1:
			obj.filters = [new fabric.Image.filters.Greenify()];
			obj.next = 2;
			obj.prev = 0;
			break;
		case 2:
			obj.filters = [new fabric.Image.filters.Blueify()];
			obj.next = 0;
			obj.prev = 1;
			break;
	}
	obj.applyFilters(p5.renderAll.bind(p5));
}

function Pixelate(obj, num) {
	obj.filters = [new fabric.Image.filters.Pixelate({
      blocksize: num
    })];
	
	obj.applyFilters(p2.renderAll.bind(p2));
}



window.addEventListener("keydown", function(e) //window
{
	if(zoom) return false;
	//e = e || window.event;
	if(pointer.c == p2) {
			if (e.keyCode == RIGHT && active.filters[0].blocksize > 5) Pixelate(active, active.filters[0].blocksize - 5);
			else if (e.keyCode == LEFT && active.filters[0].blocksize < 80) {
				Pixelate(active, active.filters[0].blocksize +5);
				return false;
			}
	} else if(pointer.c == p1) {
			if (e.keyCode == RIGHT && active.opacity < 1) {
				active.setOpacity(active.opacity + .1 );
				p1.renderAll();
			} else if(e.keyCode == LEFT && active.opacity > .2) {
				active.setOpacity(active.opacity - .1 );
				p1.renderAll();
			}
	} else if(pointer.c == p3) {
		if (e.keyCode == RIGHT || e.keyCode == LEFT) {
			for(var i in image_metadata) {
				if(image_metadata[i].objectid == active.get("objid")){
					var newstring = getMetaData(image_metadata[i], active.get("max"), active.get("lcount"));
					active.setText(newstring);
					p3.renderAll();
				}

			}
		
		}
	
	} else if(pointer.c == p4) {
			if (e.keyCode == LEFT) {
				active.getObjects()[active.curr].setVisible(false);
				var next = active.curr + 1;
				if (next > active.count) next = 0;
				active.getObjects()[next].setVisible(true);
				active.curr = next;
				p4.renderAll();
			} else if(e.keyCode == RIGHT) {
				active.getObjects()[active.curr].setVisible(false);
				var prev = active.curr - 1;
				if (prev < 0) prev = active.count;
				active.getObjects()[prev].setVisible(true);
				active.curr = prev;
				p4.renderAll();
			}		
	}
	
});

function canvasPointer() {
	this._index = 0;
	this.cid = "p1";
	this.c = p1;
	var cids = ["p1","p2","p3","p4"];
	var canvases = [p1, p2, p3, p4];
	
	this.getExtra = function() {
		switch(this._index) {
			case 0:
				return 0;
				break;
			case 1:
				return 775;
				break;
			case 2:
				return 1525;
				break;
			case 3:
				return 2300;
				break;
		}
	};
	this.activateNext = function() {
		this._index++;
		this.cid = cids[this._index];
		this.c = canvases[this._index];
	};
	this.activatePrev = function() {
		this._index--;
		this.cid = cids[this._index];
		this.c = canvases[this._index];
	};
	this.firstRightID = function() {
		if(this._index == 4) return false;
		return cids[this._index+1];
	};
	this.SecondRightID = function() {
		if(this._index == 3) return false;
		return cids[this._index+2];
	};
	this.ThirdRightID = function() {
		if(this._index > 3) return false;
		return cids[this._index+3];
	};
	this.FirstLeftID = function() {
		if(this._index == 0) return false;
		return cids[this._index-1];
	}	;
	this.SecondLeftID = function() {
		if(this._index == 1) return false;
		return cids[this._index-2];
	};
	this.ThirdLeftID = function() {
		if(this._index < 3) return false;
		return cids[this._index-3];
	};
	this.FirstRightCanvas = function() {
		if(this._index > 3) return false;
		return canvases[this._index+1];
	};
	this.SecondRightCanvas = function() {
		if(this._index > 2) return false;
		return canvases[this._index+2];
	};
	this.ThirdRightCanvas = function() {
		if(this._index > 3) return false;
		return canvases[this._index+3];
	};
	this.FirstLeftCanvas = function() {
		if(this._index < 1) return false;
		return canvases[this._index-1];
	}	;
	this.SecondLeftCanvas = function() {
		if(this._index < 2) return false;
		return canvases[this._index-2];
	};
	this.ThirdLeftCanvas = function() {
		if(this._index < 3) return false;
		return canvases[this._index-3];
	};
	this.setCanvas = function(cid) {
		var i = cids.indexOf(cid);
		if(i == -1) return false;
		this.cid = cid;
		this.c = canvases[i];
		this._index = i;
	};
	this.getIndex = function() {
		return this._index;
	}
	
	this.renderAll = function() {
		$.each(canvases, function(i, c) {
			c.renderAll();
		});
	}
}

</script>



	</body>
</html>