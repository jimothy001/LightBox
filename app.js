//..................initialize required modules
var express = require('express'); 
var methodOverride = require('method-override');
var bodyParser = require('body-parser');
var serveStatic = require('serve-static');
var finalhandler = require('finalhandler');
var errorhandler = require('errorhandler');
var mongoose = require('mongoose');



var app=express();
var http=require('http');


//configure express as a typical web server // UPDATED FOR CONNECT
//redirect to html
app.get("/", function(req, res) { //get method is specific to express, not connect
  res.redirect("/sandbox.html");
});

//use middleware for http server framework
//add detail
app.use(methodOverride());

app.use(bodyParser.urlencoded({extended:false}));

app.use(bodyParser.json());

app.use(serveStatic(process.cwd()+'/scripts'));
var serve = serveStatic('public', {'sandbox':['sandbox.html']});

app.use(errorhandler({
	dumpExceptions: true,
	showStack: true
}));

//make a little server that serves contents of 'public'
var server = http.createServer(function(req,res){
	var done = finalhandler(req, res);
	serve(req, res, done);
});

//listen for visitors
server.listen(process.env.PORT || 6789);


//................................Socket.io
//initialize socket.io to listen to the same server as express
var io = require('socket.io').listen(server);
io.set('log level', 1);    //reduce the amount of debugging output written to the console



//list of online users
var users={};

//current color
var color="#000000";       
//a dummy counter used in order to generate incremental unique user ids
var count=1;  


/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//MONGO DB
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

//.....................................................MongoDB
//.................open a connection to the mongodb server

var server = process.env.MONGOLAB_URI || 'mongodb://localhost/my_database';
var port = process.env.PORT || 27017;
mongoose.connect(server, function (err, res) {
  if (err) { 
    console.log ('ERROR connecting to: ' + server + '. ' + err);
  } else {
    console.log ('Succeeded connected to: ' + server);
  }
});

var Art = mongoose.model('Art', {created: Date, url: String});



/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//SOCKET IO
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


io.sockets.on('connection', function (socket) {
	
	//attach a custom user object to the socket
	socket.user={"sharedData":{}};
	socket.user.id= ""+count;	//assign a unique id to the user

	socket.user.socket=socket;	//assign the socket to hte user so that each user knows her connection conduit	
	users[socket.user.id]=socket.user; //register the new user to the list of users
	socket.user.sharedData.id = socket.user.id;


	//this event is automatically fired when a user disconnects
	socket.on('disconnect', function () {
		//socket.emit('Bye', {"bye":"bye"});
		//SaveEdit("UserLeft", {"id":socket.user.id, "ci":socket.user.ci, "s_id":socket.id});	//notify all other users that this socket's user left
		delete users[socket.user.id];    //delete the user from the list
	});

	socket.on('add-item', function(data) {
		console.dir(data);
		var art = new Art({url: data.url, created: new Date()});
		art.save();
		socket.emit('updated-db', data);
	});
	
	socket.on('get-items', function(data) {
		console.log("GET ITEMS");
		Art.find().sort('-created').limit(10).exec(function(err, results) {
			if(err) return res.send(err);
			console.log(results);
			socket.emit('send-items', results);
		});
		
	});
	
});




